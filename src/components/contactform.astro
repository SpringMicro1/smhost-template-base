---
import Button from "./ui/button.astro";
const res = await fetch("http://localhost:8001/v1/forms/6463a4f7de995bc1fab27f7d", {
  headers: {
    "x-api-key": import.meta.env.PUBLIC_API_KEY!
  }
})
const form = await res.json()
---

<form
  action="http://localhost:8001/v1/forms/contact/6463a4f7de995bc1fab27f7d/submit?callback-url=http://localhost:3000/contact"
  method="POST"
  id="form"
  class="needs-validation"
  novalidate>
  {form.fieldsets.map(f => <fieldset>
    <legend class="hidden">{f.legend_text}</legend>  
    {f.inputs.map(i => <div class="mb-5">
      <input
        type={i.input_type}
        placeholder={i.label_text}
        required={i.required}
        class={`w-full px-4 py-3 border-2 placeholder:text-gray-800 rounded-md outline-none focus:ring-4 border-gray-300 focus:border-gray-600 ring-gray-100 ${i.hidden ? "hidden" : ""}`}
        name={i.name}
        value={i.initial_value}
      />
      <div id={`error-${i.name}`} class="hidden text-red-400 text-sm mt-1"></div>
    </div>)}
    
  </fieldset>)}
  <Button type="submit" size="lg" block>Send Message</Button>
  <div id="result" class="mt-3 text-center"></div>
</form>

<script is:inline>
  const urlSearchParams = new URLSearchParams(window.location.search);
  const params = Object.fromEntries(urlSearchParams.entries());
  console.log('params', params);
  if (params["data"]) {
    const data = JSON.parse(atob(params["data"]))
    Object.entries(data).forEach(([k,v]) => {
      const el = document.querySelector(`input[name="${k}"]`)
      if (v.value) {
        el.value = v.value;
      }
      if (v.errors.length > 0) {
        const err = document.querySelector(`#error-${k}`)
        err.classList.remove("hidden")
        err.innerHTML = v.errors.join("<br>")
      }
    })
  }
</script>
